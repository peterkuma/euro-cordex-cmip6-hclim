#!/usr/bin/env python3
"""Plot model ranking.

Usage: bin/plot_ranking INPUT OUTPUT

Arguments:

  INPUT   Model ranking produced by model_ranking (NetCDF).
  OUTPUT  Output plot (PDF).
"""

import signal

signal.signal(signal.SIGINT, signal.SIG_DFL)

import os
import sys

import ds_format as ds
import matplotlib as mpl
import matplotlib.pyplot as plt
import numpy as np
from lib import misc
from matplotlib.gridspec import GridSpec

try:
    mpl.font_manager.fontManager.addfont(
        os.path.join(os.path.expanduser("~"), ".fonts", "OpenSans-Regular.ttf")
    )
except:
    pass

mpl.rc("font", family="Droid Sans")
mpl.rc("axes", linewidth=0.3)
mpl.rc("lines", linewidth=1.2)
mpl.rc("xtick.major", width=0.3)
mpl.rc("ytick.major", width=0.3)
mpl.rc("legend", framealpha=1)
mpl.rc("legend", facecolor="#eeeeee")
mpl.rc("legend", edgecolor="none")
mpl.rc("legend", fancybox=False)
mpl.rc("legend", fontsize=7)
mpl.rc("grid", color="k")
mpl.rc("grid", alpha=0.3)
mpl.rc("grid", lw=0.2)


COLORS = ["#e2ba00", "#1674ff", "#cc133a"]

NCOLS = 4

VARIABLES = {
    "tas": "Temperature",
    "tasmin": "Min. temperature",
    "tasmax": "Max. temperature",
    "pr": "Precipitation",
    "psl": "Sea-level pressure",
}


def plot(sources, ranks, title, color):
    mask = ~np.isnan(ranks)
    sources = sources[mask]
    ranks = ranks[mask]
    order = np.argsort(ranks)
    sources = sources[order]
    ranks = ranks[order]
    labels = [
        misc.get_source_title(misc.parse_dataset_name("x_" + s))
        for s in sources
    ]
    labels = ["%d. %s" % (i + 1, label) for i, label in enumerate(labels)]
    plt.barh(np.array(labels)[::-1], ranks[::-1], color=color)
    plt.xlim(1, 6)
    plt.xticks(range(1, 7))
    for spine in plt.gca().spines.values():
        spine.set_visible(False)
    plt.tick_params(axis="y", which="both", length=0)
    plt.title(title)
    plt.grid(axis="x")
    plt.gca().set_axisbelow(True)
    for label in plt.gca().get_yticklabels():
        label.set_ha("left")
    plt.gca().tick_params(axis="y", pad=103)


if __name__ == "__main__":
    if len(sys.argv) != 3:
        sys.stderr.write(sys.modules[__name__].__doc__)
        sys.exit(1)

    input_ = sys.argv[1]
    output = sys.argv[2]

    d = ds.read(input_)

    n = 1 + ds.dim(d, "var") + ds.dim(d, "region")

    ncols = NCOLS
    nrows = int(np.ceil(n / ncols))

    plt.figure(figsize=(14, 8))

    gs = GridSpec(nrows, ncols, hspace=0.5, wspace=1.1)

    k = 0
    plt.subplot(gs[k])
    k += 1

    plot(d["source"], d["rank_total"], "Total", COLORS[0])

    for i, var in enumerate(d["var"]):
        plt.subplot(gs[k])
        plot(d["source"], d["rank_var"][i], VARIABLES[var], COLORS[1])
        k += 1

    for i, region in enumerate(d["region"]):
        plt.subplot(gs[k])
        plot(
            d["source"], d["rank_region"][i], misc.REGIONS[region][0], COLORS[2]
        )
        k += 1

    plt.savefig(output, bbox_inches="tight")
    print("-> %s" % output)
