#!/usr/bin/env python3
"""Create an index of metadata of a directory with model dataset files.

Usage: index DIR...

Arguments:

  DIR  Directory to index (NetCDF).
"""

import signal

signal.signal(signal.SIGINT, signal.SIG_DFL)

import os
import pickle
import sys
from concurrent.futures import ProcessPoolExecutor

from lib import io

if __name__ == "__main__":
    if len(sys.argv) < 2:
        sys.stderr.write(sys.modules[__name__].__doc__)
        sys.exit(1)
    dirs = sys.argv[1:]

    with ProcessPoolExecutor() as ex:
        for dir in dirs:
            index = io.list_dataset(dir, ex=ex, force=True)
            filename = os.path.join(dir, "index.pkl")
            with open(filename, "wb") as f:
                pickle.dump(index, f)
