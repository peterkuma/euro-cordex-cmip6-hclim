#!/usr/bin/env python3
"""Plot boxplots showing the HCLIM statistics for every variable, region, and season.

Usage: bin/plot_boxplot INPUT SOURCE... START END OUTPUT

Arguments:

  INPUT       Input directory with period-season-region statistics produced by calc_stats (NetCDF).
  SOURCE      Source name.
  START       Start year.
  END         End year.
  OUTPUT      Output directory (PDF).
"""

import signal

signal.signal(signal.SIGINT, signal.SIG_DFL)

import os
import sys

import ds_format as ds
import matplotlib as mpl
import matplotlib.pyplot as plt
import numpy as np
from lib import io, misc
from matplotlib.gridspec import GridSpec

try:
    mpl.font_manager.fontManager.addfont(
        os.path.join(os.path.expanduser("~"), ".fonts", "OpenSans-Regular.ttf")
    )
except:
    pass

mpl.rc("font", family="Open Sans")
mpl.rc("axes", linewidth=0.3)
mpl.rc("axes", grid=True)
mpl.rc("lines", linewidth=1.2)
mpl.rc("xtick.major", width=0.3)
mpl.rc("ytick.major", width=0.3)
mpl.rc("legend", framealpha=1)
mpl.rc("legend", facecolor="#eeeeee")
mpl.rc("legend", edgecolor="none")
mpl.rc("legend", fancybox=False)
mpl.rc("legend", fontsize=7)
mpl.rc("grid", color="k")
mpl.rc("grid", alpha=0.2)
mpl.rc("grid", lw=0.1)

VARIABLES = [
    "tas",
    "tasmin",
    "tasmax",
    "pr",
    "psl",
]

LABEL = {
    "tas": "Temperature (°C)",
    "tasmin": "Min. temperature (°C)",
    "tasmax": "Max. temperature (°C)",
    "pr": "Precipitation (mm mon$^{-1}$)",
    "psl": "Sea-level pressure (hPa)",
}

FACTOR = {
    "pr": 24 * (365.2425 / 12),  # mm mon-1.
    "psl": 1e-2,  # hPa.
}

SEASONS = [
    "ANN",
    "MAM",
    "JJA",
    "SON",
    "DJF",
]

REGIONS = [
    "BI",
    "IP",
    "FR",
    "ME",
    "SC",
    "AL",
    "MD",
    "EA",
]

VLIM = {
    "tas": [0, 20],
    "tasmin": [-3, 15],
    "tasmax": [2, 22],
    "pr": [25, 175],
    "psl": [1000, 1020],
}


def read(input_, var, names, season, region, source, index):
    desc = {
        "variable_id": var,
        "season": season,
        "region_code": region,
        "start_year": start,
        "end_year": end,
        "source": source,
    }
    dd = io.read_dataset(
        input_,
        desc,
        names,
        merge=False,
        index=index,
    )
    # print(input_, var, names, season, region, source, len(dd))
    if len(dd) == 1:
        return dd[0]
    elif len(dd) == 0:
        return
    else:
        raise IOError(
            "too many input files for var = %s, season = %s, region = %s, source = %s"
            % (var, season, region, source)
        )


if __name__ == "__main__":
    if len(sys.argv) < 6:
        sys.stderr.write(sys.modules[__name__].__doc__)
        sys.exit(1)
    input_ = sys.argv[1]
    sources = sys.argv[2:-3]
    start = int(sys.argv[-3])
    end = int(sys.argv[-2])
    output = sys.argv[-1]

    index = io.list_dataset(input_)
    nrows = len(VARIABLES)
    ncols = len(SEASONS)

    labels = [
        misc.get_source_title(misc.parse_dataset_name("x_" + source))
        for source in sources
    ]

    for region in misc.REGIONS.keys():
        plt.figure(figsize=(12, 12))
        gs = GridSpec(
            len(VARIABLES),
            len(SEASONS),
            hspace=0.05,
            wspace=0.05,
        )
        for i, var in enumerate(VARIABLES):
            var_axes = []
            ylim = [np.nan, -np.nan]
            name = var + "_mean_ts"
            for j, season in enumerate(SEASONS):
                var_axes += [plt.subplot(gs[i * ncols + j])]
                xx = []
                for source in sources:
                    d = read(input_, var, [name], season, region, source, index)
                    factor = FACTOR.get(var, 1)
                    if d is None or (
                        var == "pr" and ds.attr(d, "source_id") == "CERRA"
                    ):
                        x = []
                    else:
                        x = d[name] * factor
                    xx += [x]
                plt.boxplot(
                    xx,
                    patch_artist=True,
                    boxprops=dict(facecolor="skyblue", edgecolor="none"),
                    medianprops=dict(color="red", linewidth=2),
                    whiskerprops=dict(color="black", linewidth=0.5),
                    capprops=dict(color="black"),
                    flierprops=dict(
                        markerfacecolor="black",
                        markeredgecolor="none",
                        markersize=3,
                    ),
                )
                ylim1 = plt.gca().get_ylim()
                ylim = [
                    np.nanmin([ylim[0], ylim1[0]]),
                    np.nanmax([ylim[1], ylim1[1]]),
                ]
                if i == 0:
                    plt.title(season)
                if i != nrows - 1:
                    plt.gca().set_xticklabels([])
                else:
                    plt.gca().set_xticklabels(labels, rotation=90)
                if j != 0:
                    plt.gca().set_yticklabels([])
                else:
                    plt.ylabel(LABEL[var])
            for ax in var_axes:
                ax.set_ylim(ylim)
        plt.suptitle(misc.REGIONS[region][0], y=0.93, fontsize=16)
        file = "%s.pdf" % region
        output_filename = os.path.join(output, file)
        plt.savefig(output_filename, bbox_inches="tight")
        print("-> %s" % output_filename)
